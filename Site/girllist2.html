<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
    <meta http-equiv="Pragma" content="no-cache"/>
    <meta http-equiv="Expires" content="0"/>
    <meta charset="UTF-8">
    <style>
        body {
            background-color: #E6E6E6;
            color: #323232;
        }

        input[type=checkbox] {
            /* Double-sized Checkboxes */
            -ms-transform: scale(2); /* IE */
            -moz-transform: scale(2); /* FF */
            -webkit-transform: scale(2); /* Safari and Chrome */
            -o-transform: scale(2); /* Opera */
            padding: 10px;
        }

        div #name {
            font-weight: bold;
            font-size: xx-large;
        }

        #buttonsdiv {
            width: 1024px;
        }

        label {
            white-space: pre;
            font-size: x-large;
        }

        .girlnamebutton {
            vertical-align: top;
            font-size: 25px;
            width: 100%;
            height: 70px;
            float: top;
        }

        .basicbutton {
            vertical-align: top;
            font-size: 20px;
            height: 70px;
            width: 150px;
        }

        .battlebutton {
            vertical-align: top;
            font-size: 35px;
        }

        #preloader {
            display: inline-block;
            vertical-align: center;
            float: right;
        }

        #battle {
            float: right;
        }

        span {
            color: #657ab1;
            font-size: 25px;
            white-space: pre;
        }
    </style>
    <title>Character List</title>
    <script src="/scripts/p5.min.js"></script>
    <script src="/scripts/constants.js"></script>
    <script src="/scripts/generalinterface.js"></script>
    <script src="/scripts/bottomcanvas.js"></script>
    <script src="/scripts/rightsketch.js"></script>
    <script src="/scripts/girllistbuttonsleft.js"></script>
</head>
<body>


<script>
    'use strict';
    let struc;
    let response;
    let currentGirls = [];
    let num;
    let tags = [];
    let colours = [];
    let rarities = [];
    let colourMap = new Map([
        ["Red", 0],
        ["Orange", 1],
        ["Yellow", 2],
        ["Green", 3],
        ["Cyan", 4],
        ["Blue", 5],
        ["Violet", 6],
        ["Pink", 7],
        ["Gray", 8],
        ["Brown", 9],
        ["Black", 10],
        ["White", 11],
    ]);
    let raritiesMap = new Map([
        ["ST", 0],
        ["AD", 1],
        ["SP", 2],
        ["RP", 3],
        ["LF", 4],
    ]);
    let curNum = 0;
    let mainNum = -1;
    let secNum = -1;
    let clearClickable = false;
    let ws;

    function setCookie(name, value, hrs) {
        let expires = "";
        if (hrs) {
            let date = new Date();
            date.setTime(date.getTime() + (hrs * 60 * 60 * 1000));
            expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + (value || "") + expires + "; path=/";
    }

    function getCookie(name) {
        let nameEQ = name + "=";
        let ca = document.cookie.split(';');
        for (let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) == ' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
    }

    document.onkeypress = (key) => {

        if ((getChar(key) === 13) || (getChar(key).toLowerCase() === " ")) {
            console.log(getChar(key));
            battle()
        } else if (getChar(key).toLowerCase() === "1") {
            setasmain()
        } else if (getChar(key).toLowerCase() === "2") {
            setassec()
        } else if (getChar(key).toLowerCase() === "3") {
            clearsetgirls()
        } else if (getChar(key).toLowerCase() === "r") {
            random()
        }
    };

    function getChar(event) {

        if (event.which == null) { // IE
            if (event.keyCode < 32) return event.keyCode; // спец. символ
            return String.fromCharCode(event.keyCode)
        }
        if (event.which !== 0 && event.charCode !== 0) { // все кроме IE

            if (event.which < 32) return event.keyCode; // спец. символ
            return String.fromCharCode(event.which); // остальные
        }
        return null; // спец. символ

    }

    function getGirlByNumber(number) {
        for (let girl of response) {
            if (girl.Number === number) {
                return girl
            }
        }
    }

    function refreshCurGirl(number) {
        num = number;
        let curGirl = getGirlByNumber(number);
        //put her info in the doc

        getElementRight("name").setText(curGirl.Name + " (" + curGirl.Number + ")");
        getElementRight("rarity").setText(curGirl.Rarity);
        switch (curGirl.Rarity) {
            case "LF":
                //star
                getElementRight("rarity").setColour(WINC);
                break;
            case "RP":
                //green
                getElementRight("rarity").setColour(GREEN);
                break;
            case "SP":
                //yellow
                getElementRight("rarity").setColour(YELLOW);
                break;
            case "AD":
                //blue
                getElementRight("rarity").setColour(BLUE);
                break;
            case "ST":
                //white
                getElementRight("rarity").setColour(DARKC);
                break;
            default:
                console.log("EXCUSE ME");
                break;
        }
        getElementRight("level").setText("Level: " + curGirl.Level);
        getElementRight("matchesPlayed").setText("Matches played: " + curGirl.MatchesPlayed);
        let winrate = "";
        if (curGirl.MatchesPlayed !== 0) {
            winrate = " (" + Math.floor(curGirl.MatchesWon / curGirl.MatchesPlayed * 100) + "%)";
        }
        getElementRight("matchesWon").setText("Matches won: " + curGirl.MatchesWon + winrate);
        //let name = "Speed";
        let name = curGirl.Name;
        if (!imageBox.contains(name)) {
            if (existsPortrait(curGirl.Number)) {
                imageBox.add(new InterfaceImage(rightP, 519.5, 5, "/images/locked/" + name + "_portrait.png", "girl", name, 201, 268, curGirl.MainColour));
            } else {
                imageBox.add(new InterfaceImage(rightP, 519.5, 5, "/images/locked/Placeholder_portrait.png", "girl", name, 201, 268, curGirl.MainColour));
            }
        }
        getElementRight("girl").set(imageBox.get(name));
        let tags = "";
        for (let tag of curGirl.Tags.sort()) {
            tags += tag + ", "
        }
        tags = tags.slice(0, tags.length - 2);
        getElementRight("tags").setText("Tags: " + tags);
        let skills = "";
        for (let s of curGirl.Skills) {
            skills += s + ", "
        }
        skills = skills.slice(0, skills.length - 2);
        getElementRight("skills").setText("Skills: " + skills);
        let colours = "";
        for (let s of curGirl.SkillColours) {
            colours += s + ", "
        }
        colours = colours.slice(0, colours.length - 2);
        getElementRight("skillcolours").setText("Skill colours: " + colours);
        let description = curGirl.Description;
        let lines = interfaceCalculateLines(rightP, description, 738, 28);
        if (lines > 1) {
            can3.resize(748, 413 + (lines - 1) * 33);
        } else {
            can3.resize(748, 413);
        }
        getElementRight("description").setText(description);
        //document.getElementById("description").textContent = curGirl.Description;*


        //check if she can be picked
        curNum = curGirl.Number;
        if (bottomReady) {
            getElementBottom("setmain").clickable = !(curNum === mainNum);
            getElementBottom("setsec").clickable = !(curNum === secNum);

        }
        if (curNum === mainNum && bottomReady) {
            getElementRight("mainset").setText("Set as Main!")
            //document.getElementById("mainset").textContent = "Set as Main!";
        } else if (bottomReady) {
            getElementRight("mainset").setText("")
            ///document.getElementById("mainset").textContent = "";
        }
        if (curNum === secNum && bottomReady) {
            getElementRight("secset").setText("Set as Secondary!")
            //document.getElementById("secset").textContent = "Set as Secondary!";
        } else if (bottomReady) {
            getElementRight("secset").setText("")
            //document.getElementById("secset").textContent = "";
        }
    }

    function display(girllist) {
        let textS = 45;
        let height = (75) * girllist.length + 5;
        if (height > canHeight && can.height !== height) {
            console.log("YES", girllist.length, height);
            can.resize(canWidth, height);
        } else if (can.height !== height) {
            console.log("NO", girllist.length, height);
            can.resize(canWidth, canHeight);
        }
        emptyLeft();
        for (let i = 0; i < girllist.length; i++) {
            let girl = girllist[i];
            let t = girl.Name;
            leftP.textSize(textS);
            let w = leftP.textWidth(t);
            let button = new InterfaceButton(leftP, 5, (75) * i + 5, t, textS, "girl" + i, "B", 250);
            button.onClick = function () {
                this.index = girl.Number;
                refreshCurGirl(this.index);
            };
            let c = leftP.lerpColor(leftP.color(girl.MainColour), light, 0.45);
            button.setColour(c.toString());
            leftobjects.push(button);
        }
    }

    function okayforfilter(girl, filter, type) {
        return (type === "colour" && girl.SkillColours.indexOf(filter) !== -1 ||
                type === "rarity" && girl.Rarity === filter ||
                type === "tag" && girl.Tags.indexOf(filter) !== -1);
    }

    function checkallothers(girl, filter, type) {
        if (type === "colour") {
            for (let colour of girl.SkillColours) {
                if (colour !== filter && document.getElementById(colour).checked) {
                    return true;
                }
            }
            return false;
        } else if (type === "tag") {
            for (let tag of girl.Tags) {
                if (tag !== filter && document.getElementById(tag).checked) {
                    return true;
                }
            }
            return false;

        }
    }

    function oneofall(girl) {
        if (!document.getElementById(girl.Rarity).checked) {
            return false;
        } else {
            let verdict = false;
            for (let colour of girl.SkillColours) {
                if (document.getElementById(colour).checked) {
                    verdict = true;
                    break;
                }
            }
            if (!verdict) {
                return verdict;
            }
            verdict = false;
            for (let tag of girl.Tags) {
                if (document.getElementById(tag).checked) {
                    verdict = true;
                    break;
                }
            }
            return verdict;
        }
    }

    function updatedisplay(filter, type) {
        //1. get a list of everything needed
        let tyanlist = [];
        let checked = document.getElementById(filter).checked;

        if (checked) {
            for (let girl of response) {
                if (oneofall(girl)) {
                    tyanlist.push(girl);
                }
            }
        } else {
            for (let girl of currentGirls) {
                if (!okayforfilter(girl, filter, type) || okayforfilter(girl, filter, type) &&
                        type !== "rarity" && checkallothers(girl, filter, type)) {
                    tyanlist.push(girl);
                }
            }
        }

        //2. display it
        currentGirls = tyanlist.slice(0);
        display(currentGirls);

    }

    function parse(response) {
        let presets = getCookie("GirlList");
        if (presets !== null) {
            let arr = presets.split(" ");
            mainNum = +arr[0];
            secNum = +arr[1];
            clearClickable = true;
        } else {
            clearClickable = false;
        }

        display(response);

        for (let girl of response) {
            //sobiraem colors
            for (let colour of girl.SkillColours) {
                if (colours.indexOf(colour) === -1) {
                    colours.push(colour);
                }
            }

            //sobiraem rarities
            if (rarities.indexOf(girl.Rarity) === -1) {
                rarities.push(girl.Rarity);
            }

            //sobiraem tags
            for (let tag of girl.Tags) {
                if (tags.indexOf(tag) === -1) {
                    tags.push(tag);
                }
            }
        }
        //sorting
        colours.sort((a, b) => (colourMap.get(a) > colourMap.get(b)) ? 1 : ((colourMap.get(b) > colourMap.get(a)) ? -1 : 0));
        rarities.sort((a, b) => (raritiesMap.get(a) > raritiesMap.get(b)) ? 1 : ((raritiesMap.get(b) > raritiesMap.get(a)) ? -1 : 0));
        tags.sort();

        //filters.
        let i = 4;
        for (let colour of colours) {
            document.getElementById("coloursfilter").innerHTML += "<input onchange='updatedisplay(\"" + colour
                    + "\",\"colour\"" + ")' type=\"checkbox\" id=\"" + colour
                    + "\" checked><label for=\"" + colour + "\"> " + colour + " </label>";
            i--;
            if (i % 4 === 0) {
                document.getElementById("coloursfilter").innerHTML += "<br>";
            }
        }

        for (let rarity of rarities) {
            document.getElementById("raritiesfilter").innerHTML += "<input onchange='updatedisplay(\"" + rarity
                    + "\",\"rarity\"" + ")' type=\"checkbox\" id=\"" + rarity
                    + "\" checked><label for=\"" + rarity + "\"> " + rarity + " </label><br>";
        }
        i = 3;
        for (let tag of tags) {
            document.getElementById("tagsfilter").innerHTML += "<input onchange='updatedisplay(\"" + tag
                    + "\",\"tag\"" + ")' type=\"checkbox\" id=\"" + tag
                    + "\" checked><label for=\"" + tag + "\"> " + tag + " </label>";
            i--;
            if (i % 3 === 0) {
                document.getElementById("tagsfilter").innerHTML += "<br>";
            }
        }
        console.log("parse is rdy");
    }

    function getgirllist() {
        let xhr = new XMLHttpRequest();
        xhr.open('POST', '/girllist', true);
        xhr.send();
        xhr.onreadystatechange = (e) => {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    let all = JSON.parse(xhr.responseText);
                    //let responseText = "{\"girls\":[{\"MainColour\":\"rgb(255,69,002)\",\"Number\":1,\"Level\":2,\"MatchesPlayed\":10,\"MatchesWon\":0,\"Name\":\"Storyteller\",\"Rarity\":\"LF\",\"Tags\":[\"Control\",\"Meta\",\"Heal\",\"Colours\"],\"Skills\":[\"Your Number\",\"Your Colour\",\"Your Dream\",\"My Story\"],\"SkillColours\":[\"Orange\",\"White\",\"Violet\",\"Blue\"],\"Description\":\"The one that is the beginning and the end, and also in obnoxiously loud and annoying and talk a lot and has a very long description that nobody will read anyway so I'll just type more stuff because I can, of course!\"},{\"MainColour\":\"rgb(255,249,151)\",\"Number\":10,\"Level\":20,\"MatchesPlayed\":179,\"MatchesWon\":179,\"Name\":\"Ruby\",\"Rarity\":\"SP\",\"Tags\":[\"Aggressive\",\"Preventive\",\"Output\",\"Combo\"],\"Skills\":[\"Dance\",\"Rage\",\"Stop\",\".Execute\"],\"SkillColours\":[\"Yellow\",\"Red\",\"Cyan\",\"Red\"],\"Description\":\"A fierce fighter that dances till the end.\"}, {\"MainColour\":\"rgb(255,69,002)\",\"Number\":1,\"Level\":2,\"MatchesPlayed\":10,\"MatchesWon\":0,\"Name\":\"Storyteller\",\"Rarity\":\"LF\",\"Tags\":[\"Control\",\"Meta\",\"Heal\",\"Colours\"],\"Skills\":[\"Your Number\",\"Your Colour\",\"Your Dream\",\"My Story\"],\"SkillColours\":[\"Orange\",\"White\",\"Violet\",\"Blue\"],\"Description\":\"The one that is the beginning and the end.\"}, {\"MainColour\":\"rgb(255,69,002)\",\"Number\":1,\"Level\":2,\"MatchesPlayed\":10,\"MatchesWon\":0,\"Name\":\"Storyteller\",\"Rarity\":\"LF\",\"Tags\":[\"Control\",\"Meta\",\"Heal\",\"Colours\"],\"Skills\":[\"Your Number\",\"Your Colour\",\"Your Dream\",\"My Story\"],\"SkillColours\":[\"Orange\",\"White\",\"Violet\",\"Blue\"],\"Description\":\"The one that is the beginning and the end.\"},{\"MainColour\":\"rgb(255,69,002)\",\"Number\":1,\"Level\":2,\"MatchesPlayed\":10,\"MatchesWon\":0,\"Name\":\"Storyteller\",\"Rarity\":\"LF\",\"Tags\":[\"Control\",\"Meta\",\"Heal\",\"Colours\"],\"Skills\":[\"Your Number\",\"Your Colour\",\"Your Dream\",\"My Story\"],\"SkillColours\":[\"Orange\",\"White\",\"Violet\",\"Blue\"],\"Description\":\"The one that is the beginning and the end.\"},{\"MainColour\":\"rgb(255,69,002)\",\"Number\":1,\"Level\":2,\"MatchesPlayed\":10,\"MatchesWon\":0,\"Name\":\"Storyteller\",\"Rarity\":\"LF\",\"Tags\":[\"Control\",\"Meta\",\"Heal\",\"Colours\"],\"Skills\":[\"Your Number\",\"Your Colour\",\"Your Dream\",\"My Story\"],\"SkillColours\":[\"Orange\",\"White\",\"Violet\",\"Blue\"],\"Description\":\"The one that is the beginning and the end.\"},{\"MainColour\":\"rgb(255,69,002)\",\"Number\":1,\"Level\":2,\"MatchesPlayed\":10,\"MatchesWon\":0,\"Name\":\"Storyteller\",\"Rarity\":\"LF\",\"Tags\":[\"Control\",\"Meta\",\"Heal\",\"Colours\"],\"Skills\":[\"Your Number\",\"Your Colour\",\"Your Dream\",\"My Story\"],\"SkillColours\":[\"Orange\",\"White\",\"Violet\",\"Blue\"],\"Description\":\"The one that is the beginning and the end.\"},{\"MainColour\":\"rgb(255,69,002)\",\"Number\":1,\"Level\":2,\"MatchesPlayed\":10,\"MatchesWon\":0,\"Name\":\"Storyteller\",\"Rarity\":\"LF\",\"Tags\":[\"Control\",\"Meta\",\"Heal\",\"Colours\"],\"Skills\":[\"Your Number\",\"Your Colour\",\"Your Dream\",\"My Story\"],\"SkillColours\":[\"Orange\",\"White\",\"Violet\",\"Blue\"],\"Description\":\"The one that is the beginning and the end.\"},{\"MainColour\":\"rgb(255,69,002)\",\"Number\":1,\"Level\":2,\"MatchesPlayed\":10,\"MatchesWon\":0,\"Name\":\"Storyteller\",\"Rarity\":\"LF\",\"Tags\":[\"Control\",\"Meta\",\"Heal\",\"Colours\"],\"Skills\":[\"Your Number\",\"Your Colour\",\"Your Dream\",\"My Story\"],\"SkillColours\":[\"Orange\",\"White\",\"Violet\",\"Blue\"],\"Description\":\"The one that is the beginning and the end.\"},{\"MainColour\":\"rgb(255,69,002)\",\"Number\":1,\"Level\":2,\"MatchesPlayed\":10,\"MatchesWon\":0,\"Name\":\"Storyteller\",\"Rarity\":\"LF\",\"Tags\":[\"Control\",\"Meta\",\"Heal\",\"Colours\"],\"Skills\":[\"Your Number\",\"Your Colour\",\"Your Dream\",\"My Story\"],\"SkillColours\":[\"Orange\",\"White\",\"Violet\",\"Blue\"],\"Description\":\"The one that is the beginning and the end.\"},{\"MainColour\":\"rgb(255,69,002)\",\"Number\":1,\"Level\":2,\"MatchesPlayed\":10,\"MatchesWon\":0,\"Name\":\"Storyteller\",\"Rarity\":\"LF\",\"Tags\":[\"Control\",\"Meta\",\"Heal\",\"Colours\"],\"Skills\":[\"Your Number\",\"Your Colour\",\"Your Dream\",\"My Story\"],\"SkillColours\":[\"Orange\",\"White\",\"Violet\",\"Blue\"],\"Description\":\"The one that is the beginning and the end.\"},{\"MainColour\":\"rgb(255,69,002)\",\"Number\":1,\"Level\":2,\"MatchesPlayed\":10,\"MatchesWon\":0,\"Name\":\"Storyteller\",\"Rarity\":\"LF\",\"Tags\":[\"Control\",\"Meta\",\"Heal\",\"Colours\"],\"Skills\":[\"Your Number\",\"Your Colour\",\"Your Dream\",\"My Story\"],\"SkillColours\":[\"Orange\",\"White\",\"Violet\",\"Blue\"],\"Description\":\"The one that is the beginning and the end.\"},{\"MainColour\":\"rgb(255,69,002)\",\"Number\":1,\"Level\":2,\"MatchesPlayed\":10,\"MatchesWon\":0,\"Name\":\"Storyteller\",\"Rarity\":\"LF\",\"Tags\":[\"Control\",\"Meta\",\"Heal\",\"Colours\"],\"Skills\":[\"Your Number\",\"Your Colour\",\"Your Dream\",\"My Story\"],\"SkillColours\":[\"Orange\",\"White\",\"Violet\",\"Blue\"],\"Description\":\"The one that is the beginning and the end.\"},{\"MainColour\":\"rgb(255,69,002)\",\"Number\":1,\"Level\":2,\"MatchesPlayed\":10,\"MatchesWon\":0,\"Name\":\"Storyteller\",\"Rarity\":\"LF\",\"Tags\":[\"Control\",\"Meta\",\"Heal\",\"Colours\"],\"Skills\":[\"Your Number\",\"Your Colour\",\"Your Dream\",\"My Story\"],\"SkillColours\":[\"Orange\",\"White\",\"Violet\",\"Blue\"],\"Description\":\"The one that is the beginning and the end.\"},{\"MainColour\":\"rgb(255,69,002)\",\"Number\":1,\"Level\":2,\"MatchesPlayed\":10,\"MatchesWon\":0,\"Name\":\"Storyteller\",\"Rarity\":\"LF\",\"Tags\":[\"Control\",\"Meta\",\"Heal\",\"Colours\"],\"Skills\":[\"Your Number\",\"Your Colour\",\"Your Dream\",\"My Story\"],\"SkillColours\":[\"Orange\",\"White\",\"Violet\",\"Blue\"],\"Description\":\"The one that is the beginning and the end.\"},{\"MainColour\":\"rgb(255,69,002)\",\"Number\":1,\"Level\":2,\"MatchesPlayed\":10,\"MatchesWon\":0,\"Name\":\"Storyteller\",\"Rarity\":\"LF\",\"Tags\":[\"Control\",\"Meta\",\"Heal\",\"Colours\"],\"Skills\":[\"Your Number\",\"Your Colour\",\"Your Dream\",\"My Story\"],\"SkillColours\":[\"Orange\",\"White\",\"Violet\",\"Blue\"],\"Description\":\"The one that is the beginning and the end.\"},{\"MainColour\":\"rgb(255,69,002)\",\"Number\":1,\"Level\":2,\"MatchesPlayed\":10,\"MatchesWon\":0,\"Name\":\"Storyteller\",\"Rarity\":\"LF\",\"Tags\":[\"Control\",\"Meta\",\"Heal\",\"Colours\"],\"Skills\":[\"Your Number\",\"Your Colour\",\"Your Dream\",\"My Story\"],\"SkillColours\":[\"Orange\",\"White\",\"Violet\",\"Blue\"],\"Description\":\"The one that is the beginning and the end.\"},{\"MainColour\":\"rgb(255,69,002)\",\"Number\":1,\"Level\":2,\"MatchesPlayed\":10,\"MatchesWon\":0,\"Name\":\"Storyteller\",\"Rarity\":\"LF\",\"Tags\":[\"Control\",\"Meta\",\"Heal\",\"Colours\"],\"Skills\":[\"Your Number\",\"Your Colour\",\"Your Dream\",\"My Story\"],\"SkillColours\":[\"Orange\",\"White\",\"Violet\",\"Blue\"],\"Description\":\"The one that is the beginning and the end.\"},{\"MainColour\":\"rgb(255,69,002)\",\"Number\":1,\"Level\":2,\"MatchesPlayed\":10,\"MatchesWon\":0,\"Name\":\"Storyteller\",\"Rarity\":\"LF\",\"Tags\":[\"Control\",\"Meta\",\"Heal\",\"Colours\"],\"Skills\":[\"Your Number\",\"Your Colour\",\"Your Dream\",\"My Story\"],\"SkillColours\":[\"Orange\",\"White\",\"Violet\",\"Blue\"],\"Description\":\"The one that is the beginning and the end.\"},{\"MainColour\":\"rgb(255,69,002)\",\"Number\":1,\"Level\":2,\"MatchesPlayed\":10,\"MatchesWon\":0,\"Name\":\"Storyteller\",\"Rarity\":\"LF\",\"Tags\":[\"Control\",\"Meta\",\"Heal\",\"Colours\"],\"Skills\":[\"Your Number\",\"Your Colour\",\"Your Dream\",\"My Story\"],\"SkillColours\":[\"Orange\",\"White\",\"Violet\",\"Blue\"],\"Description\":\"The one that is the beginning and the end.\"},{\"MainColour\":\"rgb(255,69,002)\",\"Number\":1,\"Level\":2,\"MatchesPlayed\":10,\"MatchesWon\":0,\"Name\":\"Storyteller\",\"Rarity\":\"LF\",\"Tags\":[\"Control\",\"Meta\",\"Heal\",\"Colours\"],\"Skills\":[\"Your Number\",\"Your Colour\",\"Your Dream\",\"My Story\"],\"SkillColours\":[\"Orange\",\"White\",\"Violet\",\"Blue\"],\"Description\":\"The one that is the beginning and the end.\"},{\"MainColour\":\"rgb(255,69,002)\",\"Number\":1,\"Level\":2,\"MatchesPlayed\":10,\"MatchesWon\":0,\"Name\":\"Storyteller\",\"Rarity\":\"LF\",\"Tags\":[\"Control\",\"Meta\",\"Heal\",\"Colours\"],\"Skills\":[\"Your Number\",\"Your Colour\",\"Your Dream\",\"My Story\"],\"SkillColours\":[\"Orange\",\"White\",\"Violet\",\"Blue\"],\"Description\":\"The one that is the beginning and the end.\"}],\"response\":\"Press \\\"Battle!\\\" when you are ready\"}";
                    //let all = JSON.parse(responseText);
                    response = all.girls.sort((a, b) => (a.Number > b.Number) ? 1 : ((b.Number > a.Number) ? -1 : 0));
                    if (bottomReady) {
                        getElementBottom("prompts").setText(all.response);
                    }
                    if (response.length > 0) {
                        console.log(response);
                        currentGirls = response.slice(0);
                        refreshCurGirl(response[0].Number);
                        parse(response);
                    } else {
                        console.log("0 girls found!!!")
                    }
                } else if (xhr.status === 303) {
                    window.location.reload(true);
                }
            }
        };
    }

    function random() {
        let old_prompt = "";
        if (bottomReady) {
            getElementBottom('clear').clickable = true;
            old_prompt = getElementBottom("prompts").text;
        }
        let len = response.length;
        let rand = Math.floor(Math.random() * len);
        let rand2 = Math.floor(Math.random() * len);
        while (rand2 === rand) {
            rand2 = Math.floor(Math.random() * len);
        }
        mainNum = response[rand].Number;
        secNum = response[rand2].Number;
        console.log(mainNum, secNum, rand, rand2, response.length);
        display(currentGirls);
        refreshCurGirl(num);
        if (old_prompt !== "") {
            getElementBottom("prompts").setText(old_prompt);
        }
    }

    function setasmain() {
        if (curNum === secNum) {
            clearsetgirls();
        }
        mainNum = curNum;
        if (bottomReady) {
            getElementBottom("setmain").clickable = false;
            getElementBottom("clear").clickable = true;

        }
        getElementRight("mainset").setText("Set as Main!")
        //document.getElementById("mainset").textContent = "Set as Main!";
    }

    function setassec() {
        if (curNum === mainNum) {
            clearsetgirls();
        }
        secNum = curNum;
        if (bottomReady) {
            getElementBottom("setsec").clickable = false;
            getElementBottom("clear").clickable = true;

        }
        getElementRight("secset").setText("Set as Secondary!")
        //document.getElementById("secset").textContent = "Set as Secondary!";
    }

    function clearsetgirls() {
        mainNum = -1;
        secNum = -1;
        if (bottomReady) {
            getElementBottom("setmain").clickable = true;
            getElementBottom("setsec").clickable = true;
            getElementBottom("clear").clickable = false;
        }

        getElementRight("mainset").setText("");
        getElementRight("secset").setText("");
        //document.getElementById("mainset").textContent = "";
        //document.getElementById("secset").textContent = "";

    }


    function battle() {
        //TODO prompt do you wanna reconnect or nah
        if (mainNum !== -1 && secNum !== -1) {
            if (ws) {
                return
            }
            if (bottomReady) {
                getElementBottom("prompts").setText("Searching for an opponent...");
            }
            let loc = window.location, new_uri;
            if (loc.protocol === "https:") {
                new_uri = "wss:";
            } else {
                new_uri = "ws:";
            }
            new_uri += "//" + loc.host + "/queue";
            ws = new WebSocket(new_uri);

            ws.onopen = function (evt) {
                console.log("OPEN");
                console.log("SEND: ", JSON.stringify({MainGirl: mainNum, SecondaryGirl: secNum,}));
                ws.send(JSON.stringify({MainGirl: mainNum, SecondaryGirl: secNum,}));
            };
            ws.onclose = function (evt) {
                console.log("CLOSE");
                ws = null;
            };
            ws.onmessage = function (evt) {
                console.log("RESPONSE: " + evt.data);
                let battleresponse = JSON.parse(evt.data);
                if (bottomReady) {
                    getElementBottom("prompts").setText(battleresponse.Prompt);
                }
                if (battleresponse.hasOwnProperty("OK") && battleresponse.OK) {
                    console.log("RELOCATE~!!");
                    setCookie("GirlList", mainNum + " " + secNum, 3);
                    location = battleresponse.Location;
                } else {
                    console.log("Server dced me :<");
                    ws.close();
                }
            };
            ws.onerror = function (evt) {
                console.log("ERROR: " + evt);
            };


        } else {
            if (bottomReady) {
                getElementBottom("prompts").setText("Please choose the girls first!");
            }
        }
    }


</script>
<table WIDTH="100%">
    <tr>
        <td>
            <div class="left" align="center">Welcome, {{.Username}}</div>
        </td>
        <td>
            <div class="left" align="center"><a href="/">Main page</a></div>
        </td>
        <td>
            <div class="center" align="center"><a href="/friends">Friend List</a></div>
        </td>
        <td>
            <div class="right" align="right"><a href="/logout">Logout</a></div>
        </td>

    </tr>
</table>


<div align="center">
    <table width="1024" height="300" border="0" rules="cols">
        <tr height="50">
            <td colspan="2">
                <!--
                filters
                -->
                <div align="center">
                    <table width="100%" height="100%" border="0">
                        <tr>
                            <td width="8%">
                                Rarities:<br>
                            </td>
                            <td width="45%">
                                Colours:<br>
                            </td>
                            <td>
                                Tags:<br>
                            </td>
                        </tr>
                        <tr>
                            <td id="raritiesfilter">
                            </td>
                            <td id="coloursfilter">
                            </td>
                            <td id="tagsfilter">
                            </td>
                        </tr>

                    </table>
                </div>
            </td>
        </tr>
        <tr>
            <td width="276" valign="top">
                <div style="overflow-y:auto; height:280px" id="girls" align="center"></div>
            </td>
            <td width="768">
                <div style="width: 768px; overflow-y:auto; height:280px" id='rightcanvas'></div>
            </td>

        </tr>

    </table>
    <table width="1044" border="0" rules="cols">
        <tr>
            <td width="1044">
                <div id="bottomcanvas"></div>
            </td>
        </tr>
    </table>
</div>
<script>
    bottomReady = false;
    new p5(leftSketch, 'girls');
    new p5(bottomSketch, 'bottomcanvas');
    new p5(rightSketch, 'rightcanvas');
</script>
</body>
</html>