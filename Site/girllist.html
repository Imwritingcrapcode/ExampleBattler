<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
    <meta http-equiv="Pragma" content="no-cache"/>
    <meta http-equiv="Expires" content="0"/>
    <meta charset="UTF-8">
    <style>
        input[type=checkbox] {
            /* Double-sized Checkboxes */
            -ms-transform: scale(2); /* IE */
            -moz-transform: scale(2); /* FF */
            -webkit-transform: scale(2); /* Safari and Chrome */
            -o-transform: scale(2); /* Opera */
            padding: 10px;
        }

        div #name {
            font-weight: bold;
            font-size: xx-large;
        }

        #buttonsdiv {
            width: 1024px;
        }

        label {
            white-space: pre;
            font-size: x-large;
        }

        .girlnamebutton {
            vertical-align: top;
            font-size: 25px;
            width: 100%;
            height: 70px;
            float: top;
        }

        .basicbutton {
            vertical-align: top;
            font-size: 20px;
            height: 70px;
            width: 150px;
        }

        .battlebutton {
            vertical-align: top;
            font-size: 35px;
        }

        #preloader {
            display: inline-block;
            vertical-align: center;
            float: right;
        }

        #battle {
            float: right;
        }

        span {
            color: #657ab1;
            font-size: 25px;
            white-space: pre;
        }
    </style>
    <title>Character List</title>
</head>
<body>


<script>
    'use strict';
    let response;
    let current = [];
    let ind;
    let tags = [];
    let colours = [];
    let rarities = [];
    let colourMap = new Map([
        ["Red", 0],
        ["Orange", 1],
        ["Yellow", 2],
        ["Green", 3],
        ["Cyan", 4],
        ["Blue", 5],
        ["Violet", 6],
        ["Pink", 7],
        ["Gray", 8],
        ["Brown", 9],
        ["Black", 10],
        ["White", 11],
    ]);
    let raritiesMap = new Map([
        ["ST", 0],
        ["AD", 1],
        ["SP", 2],
        ["RP", 3],
        ["LF", 4],
    ]);
    let curNum = 0;
    let mainNum = -1;
    let secNum = -1;

    let ws;

    function setCookie(name, value, hrs) {
        let expires = "";
        if (hrs) {
            let date = new Date();
            date.setTime(date.getTime() + (hrs * 60 * 60 * 1000));
            expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + (value || "") + expires + "; path=/";
    }

    function getCookie(name) {
        let nameEQ = name + "=";
        let ca = document.cookie.split(';');
        for (let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) == ' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
    }

    document.onkeypress = (key) => {

        if ((getChar(key) === 13) || (getChar(key).toLowerCase() === " ")) {
            console.log(getChar(key));
            battle()
        } else if (getChar(key).toLowerCase() === "1") {
            setasmain()
        } else if (getChar(key).toLowerCase() === "2") {
            setassec()
        } else if (getChar(key).toLowerCase() === "3") {
            clearsetgirls()
        } else if (getChar(key).toLowerCase() === "r") {
            random()
        }
    };

    function getChar(event) {

        if (event.which == null) { // IE
            if (event.keyCode < 32) return event.keyCode; // спец. символ
            return String.fromCharCode(event.keyCode)
        }
        if (event.which !== 0 && event.charCode !== 0) { // все кроме IE

            if (event.which < 32) return event.keyCode; // спец. символ
            return String.fromCharCode(event.which); // остальные
        }
        return null; // спец. символ

    }

    function refreshCurGirl(index) {
        ind = index;
        let curGirl = current[index];
        //put her info in the doc
        document.getElementById("name").textContent = curGirl.Name;
        document.getElementById("number").textContent = curGirl.Number;
        document.getElementById("level").textContent = curGirl.Level;
        document.getElementById("matchesPlayed").textContent = curGirl.MatchesPlayed;
        document.getElementById("matchesWon").textContent = curGirl.MatchesWon;
        if (curGirl.MatchesPlayed !== 0) {
            document.getElementById("winRate").textContent = "(" + Math.floor(curGirl.MatchesWon / curGirl.MatchesPlayed * 100) + "%)";
        } else {
            document.getElementById("winRate").textContent = "";
        }
        document.getElementById("rarity").textContent = curGirl.Rarity;
        document.getElementById("tags").textContent = curGirl.Tags.sort();
        document.getElementById("skills").textContent = curGirl.Skills;
        document.getElementById("skillcolours").textContent = curGirl.SkillColours;
        document.getElementById("description").textContent = curGirl.Description;
        //check if she can be picked
        curNum = curGirl.Number;
        document.getElementById("setmain").disabled = curNum === mainNum;
        document.getElementById("setsec").disabled = curNum === secNum;
        if (curNum === mainNum) {
            document.getElementById("mainset").textContent = "Set as Main!";
        } else {
            document.getElementById("mainset").textContent = "";
        }
        if (curNum === secNum) {
            document.getElementById("secset").textContent = "Set as Secondary!";
        } else {
            document.getElementById("secset").textContent = "";
        }


    }

    function display(girllist) {
        let all_buttons = "";
        for (let i = 0; i < girllist.length; i++) {
            let girl = girllist[i];
            let prefix = "<button class=\"girlnamebutton\" id=\"girl" + i + "\" onclick='refreshCurGirl(" + i + ")'>";
            let postfix = "</button><br>";
            all_buttons += prefix + girl.Name + postfix;
        }
        return all_buttons;
    }

    function okayforfilter(girl, filter, type) {
        return (type === "colour" && girl.SkillColours.indexOf(filter) !== -1 ||
                type === "rarity" && girl.Rarity === filter ||
                type === "tag" && girl.Tags.indexOf(filter) !== -1);
    }

    function checkallothers(girl, filter, type) {
        if (type === "colour") {
            for (let colour of girl.SkillColours) {
                if (colour !== filter && document.getElementById(colour).checked) {
                    return true;
                }
            }
            return false;
        } else if (type === "tag") {
            for (let tag of girl.Tags) {
                if (tag !== filter && document.getElementById(tag).checked) {
                    return true;
                }
            }
            return false;

        }
    }

    function oneofall(girl) {
        if (!document.getElementById(girl.Rarity).checked) {
            return false;
        } else {
            let verdict = false;
            for (let colour of girl.SkillColours) {
                if (document.getElementById(colour).checked) {
                    verdict = true;
                    break;
                }
            }
            if (!verdict) {
                return verdict;
            }
            verdict = false;
            for (let tag of girl.Tags) {
                if (document.getElementById(tag).checked) {
                    verdict = true;
                    break;
                }
            }
            return verdict;
        }
    }

    function updatedisplay(filter, type) {
        //1. get a list of everything needed
        let tyanlist = [];
        let checked = document.getElementById(filter).checked;

        if (checked) {
            for (let girl of response) {
                //console.log(oneofall(girl), girl.Name, filter);
                if (oneofall(girl)) {
                    tyanlist.push(girl);
                }
            }
        } else {
            for (let girl of current) {
                if (!okayforfilter(girl, filter, type) || okayforfilter(girl, filter, type) &&
                        type !== "rarity" && checkallothers(girl, filter, type)) {
                    tyanlist.push(girl);
                }
            }
        }

        //2. display it
        current = tyanlist.slice(0);
        document.getElementById("girls").innerHTML = display(current);

    }

    function parse(response) {
        let presets = getCookie("GirlList");
        if (presets !== null) {
            let arr = presets.split(" ");
            mainNum = +arr[0];
            secNum = +arr[1];
            document.getElementById("clear").disabled = false;
        } else {
            document.getElementById("clear").disabled = true;
        }

        document.getElementById("girls").innerHTML += display(response);

        for (let girl of response) {
            //sobiraem colors
            for (let colour of girl.SkillColours) {
                if (colours.indexOf(colour) === -1) {
                    colours.push(colour);
                }
            }

            //sobiraem rarities
            if (rarities.indexOf(girl.Rarity) === -1) {
                rarities.push(girl.Rarity);
            }

            //sobiraem tags
            for (let tag of girl.Tags) {
                if (tags.indexOf(tag) === -1) {
                    tags.push(tag);
                }
            }
        }
        //sorting
        colours.sort((a, b) => (colourMap.get(a) > colourMap.get(b)) ? 1 : ((colourMap.get(b) > colourMap.get(a)) ? -1 : 0));
        rarities.sort((a, b) => (raritiesMap.get(a) > raritiesMap.get(b)) ? 1 : ((raritiesMap.get(b) > raritiesMap.get(a)) ? -1 : 0));
        tags.sort();

        //filters.
        let i = 4;
        for (let colour of colours) {
            document.getElementById("coloursfilter").innerHTML += "<input onchange='updatedisplay(\"" + colour
                    + "\",\"colour\"" + ")' type=\"checkbox\" id=\"" + colour
                    + "\" checked><label for=\"" + colour + "\"> " + colour + " </label>";
            i--;
            if (i % 4 === 0) {
                document.getElementById("coloursfilter").innerHTML += "<br>";
            }
        }

        for (let rarity of rarities) {
            document.getElementById("raritiesfilter").innerHTML += "<input onchange='updatedisplay(\"" + rarity
                    + "\",\"rarity\"" + ")' type=\"checkbox\" id=\"" + rarity
                    + "\" checked><label for=\"" + rarity + "\"> " + rarity + " </label><br>";
        }
        i = 3;
        for (let tag of tags) {
            document.getElementById("tagsfilter").innerHTML += "<input onchange='updatedisplay(\"" + tag
                    + "\",\"tag\"" + ")' type=\"checkbox\" id=\"" + tag
                    + "\" checked><label for=\"" + tag + "\"> " + tag + " </label>";
            i--;
            if (i % 3 === 0) {
                document.getElementById("tagsfilter").innerHTML += "<br>";
            }
        }
        refreshCurGirl(0);
        document.getElementById("random").disabled = false;
    }

    function getrirllist() {
        let xhr = new XMLHttpRequest();
        xhr.open('POST', '/girllist', true);
        xhr.send();
        xhr.onreadystatechange = (e) => {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    let all = JSON.parse(xhr.responseText);
                    response = all.girls.sort((a, b) => (a.Number > b.Number) ? 1 : ((b.Number > a.Number) ? -1 : 0));
                    document.getElementById("prompts").textContent = all.response + "\r\n";
                    if (response.length > 0) {
                        console.log(response);
                        current = response.slice(0);
                        parse(response);
                    } else {
                        console.log("0 girls found!!!")
                    }
                }
            }
        };
    }

    function random() {
        let old_prompt = document.getElementById("prompts").textContent;
        document.getElementById("prompts").textContent = "Choosing random girls...";
        togglepreloader();
        document.getElementById("clear").disabled = false;
        let len = response.length;
        let rand = Math.floor(Math.random() * len);
        let rand2 = Math.floor(Math.random() * len);
        while (rand2 === rand) {
            rand2 = Math.floor(Math.random() * len);
        }
        mainNum = response[rand].Number;
        secNum = response[rand2].Number;
        console.log(mainNum, secNum, rand, rand2, response.length);
        togglepreloader();
        document.getElementById("girls").innerHTML = display(current);
        refreshCurGirl(ind);
        document.getElementById("prompts").textContent = old_prompt;
    }

    function setasmain() {
        if (curNum === secNum) {
            clearsetgirls();
        }
        mainNum = curNum;
        document.getElementById("setmain").disabled = true;
        document.getElementById("clear").disabled = false;
        document.getElementById("mainset").textContent = "Set as Main!";
    }

    function setassec() {
        if (curNum === mainNum) {
            clearsetgirls();
        }
        secNum = curNum;
        document.getElementById("setsec").disabled = true;
        document.getElementById("clear").disabled = false;
        document.getElementById("secset").textContent = "Set as Secondary!";
    }

    function clearsetgirls() {
        mainNum = -1;
        secNum = -1;
        document.getElementById("setmain").disabled = false;
        document.getElementById("setsec").disabled = false;
        document.getElementById("clear").disabled = true;
        document.getElementById("mainset").textContent = "";
        document.getElementById("secset").textContent = "";

    }


    function togglepreloader() {
        let preloader = document.getElementById("preloader");
        if (preloader.getAttribute("style") === "") {
            document.getElementById("preloader").setAttribute("style", "visibility: hidden");
        } else {
            document.getElementById("preloader").setAttribute("style", "");
        }
    }


    function battle() {
        //TODO prompt do you wanna reconnect or nah
        if (mainNum !== -1 && secNum !== -1) {
            if (ws) {
                return
            }
            togglepreloader();
            document.getElementById("random").disabled = true;
            document.getElementById("prompts").textContent = "Searching for an opponent..." + "\r\n";

            let loc = window.location, new_uri;
            if (loc.protocol === "https:") {
                new_uri = "wss:";
            } else {
                new_uri = "ws:";
            }
            new_uri += "//" + loc.host + "/queue";
            ws = new WebSocket(new_uri);

            ws.onopen = function (evt) {
                console.log("OPEN");
                console.log("SEND: ", JSON.stringify({MainGirl: mainNum, SecondaryGirl: secNum,}));
                ws.send(JSON.stringify({MainGirl: mainNum, SecondaryGirl: secNum,}));
            };
            ws.onclose = function (evt) {
                console.log("CLOSE");
                ws = null;
            };
            ws.onmessage = function (evt) {
                console.log("RESPONSE: " + evt.data);
                togglepreloader();
                let battleresponse = JSON.parse(evt.data);
                document.getElementById("prompts").textContent = battleresponse.Prompt + "\r\n";
                if (battleresponse.hasOwnProperty("OK") && battleresponse.OK) {
                    console.log("RELOCATE~!!");
                    setCookie("GirlList", mainNum + " " + secNum, 3);
                    location = battleresponse.Location;
                } else {
                    document.getElementById("random").disabled = false;
                    console.log("Server dced me :<");
                    ws.close();
                }
            };
            ws.onerror = function (evt) {
                console.log("ERROR: " + evt);
            };


        } else {
            document.getElementById("prompts").textContent = "Please choose the girls first!" + "\r\n";
        }
    }


</script>
<table WIDTH="100%">
    <tr>
        <td>
            <div class="left" align="center">Welcome, {{.Username}}</div>
        </td>
        <td>
            <div class="left" align="center"><a href="/">Main page</a></div>
        </td>
        <td>
            <div class="center" align="center"><a href="/friends">Friend List</a></div>
        </td>
        <td>
            <div class="right" align="right"><a href="/logout">Logout</a></div>
        </td>

    </tr>
</table>


<div align="center">
    <table width="1024" height="300" border="1" rules="cols">
        <tr height="50">
            <td colspan="2">
                <!--
                filters
                -->
                <div align="center">
                    <table width="100%" height="100%" border="1">
                        <tr>
                            <td width="8%">
                                Rarities:<br>
                            </td>
                            <td width="45%">
                                Colours:<br>
                            </td>
                            <td>
                                Tags:<br>
                            </td>
                        </tr>
                        <tr>
                            <td id="raritiesfilter">
                            </td>
                            <td id="coloursfilter">
                            </td>
                            <td id="tagsfilter">
                            </td>
                        </tr>

                    </table>
                </div>
            </td>
        </tr>
        <tr>
            <td width="25%" valign="top">
                <!--
                GirlList
            -->
                <div style="overflow-y:auto; height:275px" id="girls" align="center">
                </div>
            </td>
            <td width="80%">
                <!--
                girlInfo
            -->
                <div style="overflow-y:auto; height:275px">
                    <div align="right" id="mainset"></div>
                    <div align="right" id="secset"></div>
                    <div id="name">Name</div>
                    <div id="rarity"></div>
                    <br>
                    <i>Number:</i>
                    <div id="number">Number</div>
                    <i>Level:</i>
                    <div id="level">Level</div>
                    <i>Matches played:</i>
                    <div id="matchesPlayed">Matches played</div>
                    <i>Matches won:</i>
                    <div id="matchesWon">Matches won</div>
                    <div id="winRate"></div>
                    <i>Tags:</i>
                    <div id="tags"></div>
                    <i>Skills:</i>
                    <div id="skills"></div>
                    <i>Skill colours:</i>
                    <div id="skillcolours"></div>
                    <br>
                    <i>Description:</i>
                    <div id="description">Description</div>
                </div>
            </td>
        </tr>

    </table>
    <div id="buttonsdiv">
        <button class="basicbutton" id="setmain" onclick="setasmain()">Set as the Main girl</button>
        <button class="basicbutton" id="setsec" onclick="setassec()">Set as the Secondary girl</button>
        <button class="basicbutton" id="clear" onclick="clearsetgirls()">Clear set girls</button>
        <button class="basicbutton" id="random" onclick="random()">Choose random girls</button>
        <button class="battlebutton basicbutton" id="battle" onclick="battle()">Battle!</button>
        <img id="preloader" class="preloader" style="visibility: hidden"
             src="../images/loading.gif" width="64" height="64">
        <br>
        <span id="prompts"></span>
    </div>
</div>
<script>document.getElementById("random").disabled = true;
getrirllist();</script>
</body>
</html>